{
  "name": "üìÖ Appointment Scheduling Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "schedule-appointment",
        "responseMode": "responseNode"
      },
      "id": "webhook-start",
      "name": "üì® Webhook Start",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a Zorah ajudando o paciente a agendar uma consulta.\\n\\n**Informa√ß√µes do paciente:**\\n- Nome: {{$json.patient.name}}\\n- Conv√™nio: {{$json.patient.insuranceCompany}}\\n\\n**Procedimentos dispon√≠veis para o conv√™nio:**\\n{{$json.availableProcedures}}\\n\\n**Unidades dispon√≠veis:**\\n1. Vieiralves - (92) 3584-2864\\n2. S√£o Jos√© - (92) 3584-2865\\n\\n**IMPORTANTE:**\\n- SEMPRE pergunte a unidade ANTES de dar valores ou informa√ß√µes espec√≠ficas\\n- Cada unidade tem valores e hor√°rios diferentes\\n- Colete: procedimento ‚Üí unidade ‚Üí data ‚Üí turno\\n\\n**Turnos dispon√≠veis:**\\n- Manh√£ (08:00 - 12:00)\\n- Tarde (14:00 - 18:00)\\n- Noite (18:00 - 21:00)\\n\\n**Estado atual:**\\nProcedimento selecionado: {{$json.selectedProcedure}}\\nUnidade selecionada: {{$json.selectedClinic}}\\nData selecionada: {{$json.selectedDate}}\\nTurno selecionado: {{$json.selectedShift}}"
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.8,
          "maxTokens": 400,
          "jsonResponse": true
        },
        "jsonOutput": "{\\n  \\\"step\\\": \\\"select_procedure | select_clinic | select_date | select_shift | confirm\\\",\\n  \\\"extracted\\\": {\\n    \\\"procedure\\\": \\\"\\\",\\n    \\\"clinic\\\": \\\"vieiralves | sao_jose\\\",\\n    \\\"date\\\": \\\"DD/MM/AAAA\\\",\\n    \\\"shift\\\": \\\"manha | tarde | noite\\\"\\n  },\\n  \\\"message\\\": \\\"Resposta natural\\\",\\n  \\\"readyToSchedule\\\": false\\n}"
      },
      "id": "gpt-scheduling-assistant",
      "name": "ü§ñ GPT: Assistente de Agendamento",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/procedures/filter",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "insurance", "value": "={{$json.patient.insuranceCompany}}"},
            {"name": "clinic", "value": "={{$json.extracted.clinic}}"}
          ]
        }
      },
      "id": "filter-procedures",
      "name": "ü©∫ Filtrar Procedimentos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/availability",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "procedureId", "value": "={{$json.extracted.procedure}}"},
            {"name": "clinicId", "value": "={{$json.extracted.clinic}}"},
            {"name": "date", "value": "={{$json.extracted.date}}"},
            {"name": "shift", "value": "={{$json.extracted.shift}}"}
          ]
        }
      },
      "id": "check-availability",
      "name": "üïê Verificar Disponibilidade",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{"value1": "={{$json.available}}", "value2": true}]
        }
      },
      "id": "is-available",
      "name": "‚úÖ Dispon√≠vel?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "patientId", "value": "={{$json.patient.id}}"},
            {"name": "procedureId", "value": "={{$json.extracted.procedure}}"},
            {"name": "clinicId", "value": "={{$json.extracted.clinic}}"},
            {"name": "date", "value": "={{$json.extracted.date}}"},
            {"name": "time", "value": "={{$json.availableSlots[0].time}}"},
            {"name": "status", "value": "PENDING_CONFIRMATION"},
            {"name": "notes", "value": "Agendado via bot"}
          ]
        }
      },
      "id": "create-appointment",
      "name": "‚ú® Criar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1050, 250]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Infelizmente n√£o h√° hor√°rios dispon√≠veis para a data e turno selecionados.\\n\\n**Hor√°rios alternativos dispon√≠veis:**\\n{{$json.alternatives}}\\n\\nOfere√ßa essas op√ß√µes de forma amig√°vel e ajude o paciente a escolher."
            }
          ]
        },
        "options": {"temperature": 0.8, "maxTokens": 350}
      },
      "id": "gpt-alternatives",
      "name": "üîÑ GPT: Oferecer Alternativas",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1050, 350],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "jsCode": "const appointment = $json;\\nconst patient = appointment.patient;\\nconst procedure = appointment.procedure;\\nconst clinic = appointment.clinic;\\n\\nreturn {\\n  json: {\\n    ...appointment,\\n    confirmationMessage: `‚úÖ **Agendamento Confirmado!**\\\\n\\\\nüë§ Paciente: ${patient.name}\\\\nü©∫ Procedimento: ${procedure.name}\\\\nüè• Local: ${clinic.name}\\\\nüìÖ Data: ${appointment.date}\\\\nüïê Hor√°rio: ${appointment.time}\\\\n\\\\nüìß Voc√™ receber√° um e-mail de confirma√ß√£o em breve.\\\\nüì± Tamb√©m enviaremos lembretes por SMS.\\\\n\\\\nPrecisa de mais alguma coisa?`\\n  }\\n};"
      },
      "id": "format-confirmation",
      "name": "üìã Formatar Confirma√ß√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1250, 250]
    },
    {
      "parameters": {
        "batchSize": 3,
        "options": {}
      },
      "id": "split-notifications",
      "name": "üì® Split Notifica√ß√µes",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [1450, 250]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/notifications/{{$json.type}}",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "to", "value": "={{$json.to}}"},
            {"name": "template", "value": "appointment_confirmation"},
            {"name": "data", "value": "={{$json.appointment}}"}
          ]
        }
      },
      "id": "send-notification",
      "name": "üìß Enviar Notifica√ß√£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1650, 250]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "üì§ Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1850, 300]
    }
  ],
  "connections": {
    "Webhook Start": {"main": [[{"node": "GPT: Assistente de Agendamento"}]]},
    "GPT: Assistente de Agendamento": {"main": [[{"node": "Filtrar Procedimentos"}, {"node": "Verificar Disponibilidade"}]]},
    "Verificar Disponibilidade": {"main": [[{"node": "Dispon√≠vel?"}]]},
    "Dispon√≠vel?": {"main": [[{"node": "Criar Agendamento"}], [{"node": "GPT: Oferecer Alternativas"}]]},
    "Criar Agendamento": {"main": [[{"node": "Formatar Confirma√ß√£o"}]]},
    "Formatar Confirma√ß√£o": {"main": [[{"node": "Split Notifica√ß√µes"}]]},
    "Split Notifica√ß√µes": {"main": [[{"node": "Enviar Notifica√ß√£o"}], [{"node": "Response"}]]},
    "Enviar Notifica√ß√£o": {"main": [[{"node": "Split Notifica√ß√µes"}]]},
    "GPT: Oferecer Alternativas": {"main": [[{"node": "Response"}]]}
  },
  "active": false,
  "settings": {},
  "versionId": "1",
  "id": "appointment-scheduling-flow",
  "tags": ["scheduling", "appointment", "calendar"]
}
