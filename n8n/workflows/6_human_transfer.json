{
  "name": "üë§ Human Transfer Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "human-transfer",
        "responseMode": "responseNode"
      },
      "id": "webhook-start",
      "name": "üì® Webhook Start",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Crie um resumo executivo desta conversa para o atendente humano.\\n\\n**Hist√≥rico da conversa:**\\n{{$json.history}}\\n\\n**Inclua:**\\n1. Nome do paciente (se identificado)\\n2. Inten√ß√£o principal detectada\\n3. Dados j√° coletados\\n4. Problema/d√∫vida atual\\n5. A√ß√µes j√° tentadas\\n6. Motivo da transfer√™ncia\\n7. Sugest√µes para o atendente\\n\\nSeja conciso mas completo. Use bullet points."
            }
          ]
        },
        "options": {
          "temperature": 0.5,
          "maxTokens": 500
        }
      },
      "id": "gpt-create-summary",
      "name": "üìù GPT: Criar Resumo da Conversa",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "jsCode": "// Identificar motivo da transfer√™ncia\\nconst context = $json.context;\\nconst history = $json.history;\\n\\nlet reason = 'Solicita√ß√£o do paciente';\\n\\nif (context.lowConfidence) {\\n  reason = 'Baixa confian√ßa nas respostas (< 60%)';\\n} else if (context.complaint) {\\n  reason = '‚ö†Ô∏è RECLAMA√á√ÉO detectada';\\n} else if (context.multipleAttempts > 3) {\\n  reason = 'M√∫ltiplas tentativas sem sucesso';\\n} else if (context.complexSituation) {\\n  reason = 'Situa√ß√£o complexa identificada';\\n}\\n\\nreturn {\\n  json: {\\n    ...$json,\\n    transferReason: reason,\\n    priority: context.complaint ? 'HIGH' : 'NORMAL',\\n    tags: [\\n      context.complaint && 'RECLAMACAO',\\n      context.scheduling && 'AGENDAMENTO',\\n      context.cancellation && 'CANCELAMENTO'\\n    ].filter(Boolean)\\n  }\\n};"
      },
      "id": "identify-reason",
      "name": "üîç Identificar Motivo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/conversations/={{$json.conversationId}}",
        "method": "PATCH",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "queue", "value": "PRINCIPAL"},
            {"name": "status", "value": "WAITING"},
            {"name": "priority", "value": "={{$json.priority}}"},
            {"name": "transferredAt", "value": "={{$now.toISOString()}}"},
            {"name": "transferredBy", "value": "bot"},
            {"name": "transferReason", "value": "={{$json.transferReason}}"},
            {"name": "metadata", "value": "={{JSON.stringify({summary: $json.summary, tags: $json.tags})}}"}
          ]
        }
      },
      "id": "update-conversation",
      "name": "üîÑ Atualizar Conversa (Fila PRINCIPAL)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/messages",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "conversationId", "value": "={{$json.conversationId}}"},
            {"name": "from", "value": "system"},
            {"name": "type", "value": "BOT_INTENT_CONTEXT"},
            {"name": "content", "value": "={{$json.summary}}"},
            {"name": "metadata", "value": "={{JSON.stringify({isTransferSummary: true, transferReason: $json.transferReason, priority: $json.priority, tags: $json.tags})}}"}
          ]
        }
      },
      "id": "create-internal-message",
      "name": "üí¨ Criar Mensagem Interna (Resumo)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/users/agents/available",
        "method": "GET"
      },
      "id": "get-available-agents",
      "name": "üë• Buscar Agentes Dispon√≠veis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [{"value1": "={{$json.length}}", "operation": "largerThan", "value2": 0}]
        }
      },
      "id": "has-agents",
      "name": "‚úÖ Tem Agentes Dispon√≠veis?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Selecionar agente com menos conversas ativas\\nconst agents = $json;\\n\\nif (agents.length === 0) {\\n  return { json: { hasAgent: false } };\\n}\\n\\nconst selectedAgent = agents.reduce((min, agent) => \\n  agent.activeConversations < min.activeConversations ? agent : min\\n);\\n\\nreturn {\\n  json: {\\n    hasAgent: true,\\n    agent: selectedAgent,\\n    notificationMessage: `üîî **Nova Conversa na Fila**\\\\n\\\\nüë§ Paciente: ${$('Webhook Start').first().json.patient.name || 'N√£o identificado'}\\\\n‚ö†Ô∏è Prioridade: ${$('Identificar Motivo').first().json.priority}\\\\nüìã Motivo: ${$('Identificar Motivo').first().json.transferReason}\\\\n\\\\nClique para assumir o atendimento.`\\n  }\\n};"
      },
      "id": "select-agent",
      "name": "üéØ Selecionar Melhor Agente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1650, 250]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/notifications/agent",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "agentId", "value": "={{$json.agent.id}}"},
            {"name": "type", "value": "NEW_CONVERSATION"},
            {"name": "conversationId", "value": "={{$('Webhook Start').first().json.conversationId}}"},
            {"name": "message", "value": "={{$json.notificationMessage}}"},
            {"name": "priority", "value": "={{$('Identificar Motivo').first().json.priority}}"}
          ]
        }
      },
      "id": "notify-agent",
      "name": "üîî Notificar Agente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1850, 250]
    },
    {
      "parameters": {
        "jsCode": "// Mensagem quando n√£o h√° agentes dispon√≠veis\\nreturn {\\n  json: {\\n    message: `Obrigado por aguardar! üòä\\\\n\\\\nNo momento todos os nossos atendentes est√£o ocupados, mas sua conversa j√° est√° na fila com prioridade.\\\\n\\\\nVoc√™ ser√° atendido em breve! ‚è±Ô∏è\\\\n\\\\nTempo estimado: 5-10 minutos`,\\n    inQueue: true\\n  }\\n};"
      },
      "id": "no-agents-message",
      "name": "‚è∞ Mensagem: Aguardar na Fila",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1650, 350]
    },
    {
      "parameters": {
        "jsCode": "// Mensagem de transfer√™ncia para o paciente\\nreturn {\\n  json: {\\n    conversationId: $('Webhook Start').first().json.conversationId,\\n    message: `Perfeito! Vou te transferir para um atendente humano agora. üë§\\\\n\\\\nAguarde s√≥ um momento, por favor... ‚è±Ô∏è`,\\n    action: 'transfer_human',\\n    intent: 'TRANSFER',\\n    success: true,\\n    context: {\\n      transferred: true,\\n      transferredTo: $json.agent?.name || 'Fila PRINCIPAL',\\n      timestamp: new Date().toISOString()\\n    }\\n  }\\n};"
      },
      "id": "format-transfer-message",
      "name": "üì¶ Formatar Mensagem ao Paciente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/webhook/n8n-response",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "conversationId", "value": "={{$json.conversationId}}"},
            {"name": "message", "value": "={{$json.message}}"},
            {"name": "action", "value": "transfer_human"},
            {"name": "success", "value": true}
          ]
        }
      },
      "id": "send-to-system",
      "name": "üîô Enviar ao Sistema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "üì§ Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2450, 300]
    }
  ],
  "connections": {
    "Webhook Start": {"main": [[{"node": "GPT: Criar Resumo da Conversa"}]]},
    "GPT: Criar Resumo da Conversa": {"main": [[{"node": "Identificar Motivo"}]]},
    "Identificar Motivo": {"main": [[{"node": "Atualizar Conversa (Fila PRINCIPAL)"}]]},
    "Atualizar Conversa (Fila PRINCIPAL)": {"main": [[{"node": "Criar Mensagem Interna (Resumo)"}]]},
    "Criar Mensagem Interna (Resumo)": {"main": [[{"node": "Buscar Agentes Dispon√≠veis"}]]},
    "Buscar Agentes Dispon√≠veis": {"main": [[{"node": "Tem Agentes Dispon√≠veis?"}]]},
    "Tem Agentes Dispon√≠veis?": {"main": [[{"node": "Selecionar Melhor Agente"}], [{"node": "Mensagem: Aguardar na Fila"}]]},
    "Selecionar Melhor Agente": {"main": [[{"node": "Notificar Agente"}]]},
    "Notificar Agente": {"main": [[{"node": "Formatar Mensagem ao Paciente"}]]},
    "Mensagem: Aguardar na Fila": {"main": [[{"node": "Formatar Mensagem ao Paciente"}]]},
    "Formatar Mensagem ao Paciente": {"main": [[{"node": "Enviar ao Sistema"}]]},
    "Enviar ao Sistema": {"main": [[{"node": "Response"}]]}
  },
  "active": false,
  "settings": {},
  "versionId": "1",
  "id": "human-transfer-flow",
  "tags": ["transfer", "human", "queue", "priority"]
}
