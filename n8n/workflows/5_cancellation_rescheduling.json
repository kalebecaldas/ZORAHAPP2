{
  "name": "üîÑ Cancellation & Rescheduling Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "cancel-reschedule",
        "responseMode": "responseNode"
      },
      "id": "webhook-start",
      "name": "üì® Webhook Start",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a Zorah ajudando com cancelamento ou reagendamento.\\n\\n**Tarefa**: Identificar a inten√ß√£o exata:\\n- CANCELAR: cancelar um agendamento existente\\n- REAGENDAR: mudar data/hor√°rio de agendamento existente\\n\\n**Contexto:**\\nPaciente: {{$json.patient.name}}\\nAgendamentos ativos: {{$json.appointments}}"
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 200,
          "jsonResponse": true
        },
        "jsonOutput": "{\\n  \\\"intent\\\": \\\"CANCELAR | REAGENDAR\\\",\\n  \\\"appointmentId\\\": \\\"id do agendamento mencionado\\\",\\n  \\\"reason\\\": \\\"motivo (se mencionado)\\\",\\n  \\\"newDate\\\": \\\"nova data (se reagendar)\\\",\\n  \\\"newTime\\\": \\\"novo hor√°rio (se reagendar)\\\",\\n  \\\"message\\\": \\\"Resposta natural\\\"\\n}"
      },
      "id": "gpt-classify-intent",
      "name": "üß† GPT: Classificar Inten√ß√£o",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "conditions": {
          "string": [{"value1": "={{$json.intent}}", "operation": "equals", "value2": "CANCELAR"}]
        }
      },
      "id": "is-cancellation",
      "name": "‚ùå √â Cancelamento?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/={{$json.appointmentId}}",
        "method": "GET",
        "authentication": "genericCredentialType"
      },
      "id": "fetch-appointment-cancel",
      "name": "üîç Buscar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Confirme o cancelamento do agendamento:\\n\\nüìÖ {{$json.appointment.date}} √†s {{$json.appointment.time}}\\nü©∫ {{$json.appointment.procedure.name}}\\nüè• {{$json.appointment.clinic.name}}\\n\\nPergunte se o paciente tem certeza e se gostaria de reagendar."
            }
          ]
        },
        "options": {"temperature": 0.8, "maxTokens": 250}
      },
      "id": "gpt-confirm-cancellation",
      "name": "‚ö†Ô∏è GPT: Confirmar Cancelamento",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1050, 200],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/={{$json.appointmentId}}",
        "method": "PATCH",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "status", "value": "CANCELLED"},
            {"name": "cancelledBy", "value": "patient"},
            {"name": "cancellationReason", "value": "={{$json.reason || 'Solicitado via bot'}}"},
            {"name": "cancelledAt", "value": "={{$now.toISOString()}}"}
          ]
        }
      },
      "id": "cancel-appointment",
      "name": "‚ùå Cancelar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/={{$json.appointmentId}}",
        "method": "GET"
      },
      "id": "fetch-appointment-reschedule",
      "name": "üîç Buscar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Ajude o paciente a reagendar:\\n\\n**Agendamento atual:**\\nüìÖ {{$json.appointment.date}} √†s {{$json.appointment.time}}\\n\\n**Nova prefer√™ncia mencionada:**\\nüìÖ {{$json.newDate}} √†s {{$json.newTime}}\\n\\nVerifique se a nova data est√° completa e clara."
            }
          ]
        },
        "options": {"temperature": 0.8, "maxTokens": 300}
      },
      "id": "gpt-reschedule-assistant",
      "name": "üìÖ GPT: Assistente Reagendamento",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1050, 400],
      "credentials": {"openAiApi": {"id": "1"}}
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/check-availability",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "procedureId", "value": "={{$json.appointment.procedureId}}"},
            {"name": "clinicId", "value": "={{$json.appointment.clinicId}}"},
            {"name": "date", "value": "={{$json.newDate}}"},
            {"name": "time", "value": "={{$json.newTime}}"}
          ]
        }
      },
      "id": "check-new-availability",
      "name": "üïê Verificar Nova Disponibilidade",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{"value1": "={{$json.available}}", "value2": true}]
        }
      },
      "id": "new-slot-available",
      "name": "‚úÖ Novo Hor√°rio Dispon√≠vel?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/={{$json.appointmentId}}",
        "method": "PATCH",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "date", "value": "={{$json.newDate}}"},
            {"name": "time", "value": "={{$json.newTime}}"},
            {"name": "status", "value": "RESCHEDULED"},
            {"name": "rescheduledAt", "value": "={{$now.toISOString()}}"}
          ]
        }
      },
      "id": "update-appointment",
      "name": "‚úÖ Atualizar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1650, 350]
    },
    {
      "parameters": {
        "jsCode": "// Preparar notifica√ß√µes de cancelamento\\nconst appointment = $json;\\n\\nreturn {\\n  json: {\\n    ...appointment,\\n    notification: {\\n      type: 'cancellation',\\n      to: appointment.patient.phone,\\n      message: `‚ùå **Cancelamento Confirmado**\\\\n\\\\nSeu agendamento foi cancelado:\\\\nüìÖ ${appointment.date} √†s ${appointment.time}\\\\nü©∫ ${appointment.procedure.name}\\\\n\\\\nSe precisar reagendar, estou aqui para ajudar! üòä`\\n    }\\n  }\\n};"
      },
      "id": "format-cancellation-notification",
      "name": "üìß Notifica√ß√£o de Cancelamento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "jsCode": "// Preparar notifica√ß√µes de reagendamento\\nconst appointment = $json;\\n\\nreturn {\\n  json: {\\n    ...appointment,\\n    notification: {\\n      type: 'rescheduling',\\n      to: appointment.patient.phone,\\n      message: `‚úÖ **Reagendamento Confirmado!**\\\\n\\\\nüìÖ Nova data: ${appointment.date}\\\\nüïê Hor√°rio: ${appointment.time}\\\\nü©∫ Procedimento: ${appointment.procedure.name}\\\\nüè• Local: ${appointment.clinic.name}\\\\n\\\\nNos vemos l√°! üòä`\\n    }\\n  }\\n};"
      },
      "id": "format-reschedule-notification",
      "name": "üìß Notifica√ß√£o de Reagendamento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1850, 350]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/notifications/send",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "notification", "value": "={{$json.notification}}"}
          ]
        }
      },
      "id": "send-notification",
      "name": "üì® Enviar Notifica√ß√£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "üì§ Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2250, 300]
    }
  ],
  "connections": {
    "Webhook Start": {"main": [[{"node": "GPT: Classificar Inten√ß√£o"}]]},
    "GPT: Classificar Inten√ß√£o": {"main": [[{"node": "√â Cancelamento?"}]]},
    "√â Cancelamento?": {"main": [[{"node": "Buscar Agendamento"}], [{"node": "Buscar Agendamento"}]]},
    "Buscar Agendamento": {"main": [[{"node": "GPT: Confirmar Cancelamento"}]]},
    "GPT: Confirmar Cancelamento": {"main": [[{"node": "Cancelar Agendamento"}]]},
    "Cancelar Agendamento": {"main": [[{"node": "Notifica√ß√£o de Cancelamento"}]]},
    "Notifica√ß√£o de Cancelamento": {"main": [[{"node": "Enviar Notifica√ß√£o"}]]},
    "Buscar Agendamento": {"main": [[{"node": "GPT: Assistente Reagendamento"}]]},
    "GPT: Assistente Reagendamento": {"main": [[{"node": "Verificar Nova Disponibilidade"}]]},
    "Verificar Nova Disponibilidade": {"main": [[{"node": "Novo Hor√°rio Dispon√≠vel?"}]]},
    "Novo Hor√°rio Dispon√≠vel?": {"main": [[{"node": "Atualizar Agendamento"}]]},
    "Atualizar Agendamento": {"main": [[{"node": "Notifica√ß√£o de Reagendamento"}]]},
    "Notifica√ß√£o de Reagendamento": {"main": [[{"node": "Enviar Notifica√ß√£o"}]]},
    "Enviar Notifica√ß√£o": {"main": [[{"node": "Response"}]]}
  },
  "active": false,
  "settings": {},
  "versionId": "1",
  "id": "cancellation-rescheduling-flow",
  "tags": ["cancellation", "rescheduling", "appointment-management"]
}
