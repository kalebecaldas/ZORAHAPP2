{
  "name": "ü§ñ ZoraH Bot Intelligence - N8N Migration",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "zorahbot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-receiver",
      "name": "üì® Webhook: Receber Mensagem",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "zorahbot-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Extrair dados da mensagem recebida\nconst message = $input.item.json.body.message;\nconst phone = $input.item.json.body.phone;\nconst conversationId = $input.item.json.body.conversationId;\nconst patientData = $input.item.json.body.patient || {};\n\nreturn {\n  json: {\n    message,\n    phone,\n    conversationId,\n    patient: patientData,\n    timestamp: new Date().toISOString(),\n    context: {\n      hasPatient: !!patientData.id,\n      patientName: patientData.name,\n      registrationComplete: patientData.registrationComplete || false\n    }\n  }\n};"
      },
      "id": "extract-message-data",
      "name": "üîç Extrair Dados da Mensagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/conversations/{{$json.conversationId}}/context",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            }
          ]
        },
        "options": {}
      },
      "id": "load-conversation-context",
      "name": "üìö Carregar Contexto da Conversa",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Carregar dados da cl√≠nica (cache N8N)\nconst clinicData = await $('Load Clinic Data').first().json;\n\n// Mesclar contexto\nconst context = $input.item.json;\nconst conversation = $('Load Conversation Context').first().json;\n\nreturn {\n  json: {\n    ...context,\n    history: conversation.history || [],\n    patient: conversation.patient || context.patient,\n    clinic: clinicData,\n    currentIntent: conversation.currentIntent,\n    workflowContext: conversation.workflowContext || {}\n  }\n};"
      },
      "id": "merge-context",
      "name": "üîó Mesclar Contexto Completo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "={{$json.systemPrompt}}"
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 500,
          "jsonResponse": true
        },
        "jsonOutput": "{\n  \"intent\": \"INFORMACAO | AGENDAR | CANCELAR | REAGENDAR | ATRASO | RECLAMACAO | CONVERSA_LIVRE\",\n  \"sentiment\": \"positive | neutral | negative\",\n  \"confidence\": 0.95,\n  \"suggestedAction\": \"continue | transfer_human | start_workflow | collect_data\",\n  \"entities\": {\n    \"procedimento\": \"\",\n    \"convenio\": \"\",\n    \"clinica\": \"\",\n    \"data\": \"\",\n    \"horario\": \"\"\n  },\n  \"response\": \"Mensagem natural e amig√°vel\"\n}"
      },
      "id": "gpt-classifier",
      "name": "üß† GPT: Classificar Inten√ß√£o",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1050, 300],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intent}}",
              "operation": "equals",
              "value2": "INFORMACAO"
            }
          ]
        }
      },
      "id": "intent-information",
      "name": "‚ÑπÔ∏è Inten√ß√£o: INFORMA√á√ÉO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intent}}",
              "operation": "equals",
              "value2": "AGENDAR"
            }
          ]
        }
      },
      "id": "intent-schedule",
      "name": "üìÖ Inten√ß√£o: AGENDAR?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a assistente virtual Zorah da cl√≠nica. Responda de forma natural, amig√°vel e profissional sobre:\\n\\n**Procedimentos dispon√≠veis:**\\n{{$json.clinic.procedures}}\\n\\n**Conv√™nios aceitos:**\\n{{$json.clinic.insuranceCompanies}}\\n\\n**Localiza√ß√µes:**\\n{{$json.clinic.locations}}\\n\\nIMPORTANTE:\\n- Sempre pergunte a UNIDADE primeiro antes de dar valores\\n- Use valores corretos para cada unidade\\n- Seja conversacional como ChatGPT\\n- Evite listas quando poss√≠vel, converse naturalmente"
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.8,
          "maxTokens": 400
        }
      },
      "id": "gpt-information",
      "name": "üí¨ GPT: Responder Informa√ß√£o",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1450, 200],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Verificar se paciente existe\nconst phone = $json.phone;\nconst patientExists = $json.patient && $json.patient.id;\n\nreturn {\n  json: {\n    ...$json,\n    patientExists,\n    needsRegistration: !patientExists || !$json.patient.registrationComplete,\n    nextStep: patientExists ? 'select_procedure' : 'collect_patient_data'\n  }\n};"
      },
      "id": "check-patient-exists",
      "name": "üë§ Verificar Paciente Existe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.patientExists}}",
              "value2": true
            }
          ]
        }
      },
      "id": "patient-exists-decision",
      "name": "‚úÖ Paciente Cadastrado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a Zorah. Colete os seguintes dados do paciente de forma natural e conversacional:\\n\\n**Dados necess√°rios:**\\n- Nome completo\\n- CPF (validar formato: 000.000.000-00)\\n- Data de nascimento (DD/MM/AAAA)\\n- Telefone celular\\n- E-mail\\n- Endere√ßo completo (rua, n√∫mero, bairro, cidade, CEP)\\n- Conv√™nio (se tiver)\\n\\nPergunte um de cada vez, de forma amig√°vel. Valide os dados conforme necess√°rio.\\n\\n**Contexto atual:**\\nDados j√° coletados: {{$json.workflowContext.collectedData}}\\nPr√≥ximo campo a coletar: {{$json.workflowContext.nextField}}"
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 300
        }
      },
      "id": "gpt-collect-patient-data",
      "name": "üìù GPT: Coletar Dados do Paciente",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1850, 500],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/patients",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "name",
              "value": "={{$json.collectedData.name}}"
            },
            {
              "name": "cpf",
              "value": "={{$json.collectedData.cpf}}"
            },
            {
              "name": "phone",
              "value": "={{$json.phone}}"
            },
            {
              "name": "email",
              "value": "={{$json.collectedData.email}}"
            },
            {
              "name": "birthDate",
              "value": "={{$json.collectedData.birthDate}}"
            },
            {
              "name": "address",
              "value": "={{$json.collectedData.address}}"
            },
            {
              "name": "insuranceCompany",
              "value": "={{$json.collectedData.insurance}}"
            }
          ]
        }
      },
      "id": "create-patient",
      "name": "üíæ API: Criar Paciente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2050, 500]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a Zorah. O paciente est√° pronto para agendar.\\n\\n**Procedimentos dispon√≠veis para o conv√™nio {{$json.patient.insuranceCompany}}:**\\n{{$json.availableProcedures}}\\n\\n**Locais dispon√≠veis:**\\n{{$json.clinic.locations}}\\n\\nAjude o paciente a escolher:\\n1. O procedimento desejado\\n2. A unidade preferida (sempre perguntar!)\\n3. Data e hor√°rio\\n\\nSeja natural e conversacional."
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.8,
          "maxTokens": 400
        }
      },
      "id": "gpt-select-procedure",
      "name": "ü©∫ GPT: Selecionar Procedimento",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [1850, 300],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments/check-availability",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "procedureId",
              "value": "={{$json.selectedProcedure.id}}"
            },
            {
              "name": "clinicId",
              "value": "={{$json.selectedClinic.id}}"
            },
            {
              "name": "date",
              "value": "={{$json.selectedDate}}"
            },
            {
              "name": "time",
              "value": "={{$json.selectedTime}}"
            }
          ]
        }
      },
      "id": "check-availability",
      "name": "üïê API: Verificar Disponibilidade",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.available}}",
              "value2": true
            }
          ]
        }
      },
      "id": "availability-decision",
      "name": "‚úÖ Hor√°rio Dispon√≠vel?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2250, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/appointments",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "patientId",
              "value": "={{$json.patient.id}}"
            },
            {
              "name": "procedureId",
              "value": "={{$json.selectedProcedure.id}}"
            },
            {
              "name": "clinicId",
              "value": "={{$json.selectedClinic.id}}"
            },
            {
              "name": "date",
              "value": "={{$json.selectedDate}}"
            },
            {
              "name": "time",
              "value": "={{$json.selectedTime}}"
            },
            {
              "name": "status",
              "value": "PENDING_CONFIRMATION"
            }
          ]
        }
      },
      "id": "create-appointment",
      "name": "‚ú® API: Criar Agendamento",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2450, 250]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Voc√™ √© a Zorah. Infelizmente o hor√°rio solicitado n√£o est√° dispon√≠vel.\\n\\n**Alternativas dispon√≠veis:**\\n{{$json.alternatives}}\\n\\nOfere√ßa essas op√ß√µes de forma amig√°vel e ajude o paciente a escolher outra data/hor√°rio."
            },
            {
              "role": "user",
              "content": "={{$json.message}}"
            }
          ]
        },
        "options": {
          "temperature": 0.8,
          "maxTokens": 350
        }
      },
      "id": "gpt-offer-alternatives",
      "name": "üîÑ GPT: Oferecer Alternativas",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [2450, 350],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar notifica√ß√µes\\nconst appointment = $json;\\n\\nreturn {\\n  json: {\\n    ...appointment,\\n    notifications: [\\n      {\\n        type: 'SMS',\\n        template: 'appointment_confirmation',\\n        to: appointment.patient.phone\\n      },\\n      {\\n        type: 'EMAIL',\\n        template: 'appointment_confirmation',\\n        to: appointment.patient.email\\n      },\\n      {\\n        type: 'WHATSAPP',\\n        template: 'appointment_confirmation',\\n        to: appointment.patient.phone\\n      }\\n    ]\\n  }\\n};"
      },
      "id": "prepare-notifications",
      "name": "üìß Preparar Notifica√ß√µes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [2650, 250]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/notifications/send",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "notifications",
              "value": "={{$json.notifications}}"
            }
          ]
        }
      },
      "id": "send-notifications",
      "name": "üì® API: Enviar Notifica√ß√µes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2850, 250]
    },
    {
      "parameters": {
        "jsCode": "// Preparar resposta final para enviar de volta ao sistema\\nconst response = $json;\\n\\nreturn {\\n  json: {\\n    conversationId: response.conversationId,\\n    message: response.response || response.message,\\n    intent: response.intent,\\n    action: response.action || 'continue',\\n    entities: response.entities || {},\\n    context: {\\n      updated: true,\\n      timestamp: new Date().toISOString()\\n    },\\n    appointment: response.appointment || null,\\n    success: true\\n  }\\n};"
      },
      "id": "format-response",
      "name": "üì¶ Formatar Resposta Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [3050, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/webhook/n8n-response",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-N8N-Workflow-ID",
              "value": "={{$workflow.id}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}"
      },
      "id": "send-back-to-system",
      "name": "üîô Enviar Resposta ao Sistema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [3250, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "‚úÖ Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [3450, 300]
    },
    {
      "parameters": {
        "url": "={{$env.ZORAHAPP_API_URL}}/api/clinic/data",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.ZORAHAPP_API_TOKEN}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "load-clinic-data",
      "name": "üè• Carregar Dados da Cl√≠nica",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [650, 500]
    }
  ],
  "connections": {
    "Webhook: Receber Mensagem": {
      "main": [[{"node": "Extrair Dados da Mensagem"}]]
    },
    "Extrair Dados da Mensagem": {
      "main": [[{"node": "Carregar Contexto da Conversa"}, {"node": "Carregar Dados da Cl√≠nica"}]]
    },
    "Carregar Contexto da Conversa": {
      "main": [[{"node": "Mesclar Contexto Completo"}]]
    },
    "Carregar Dados da Cl√≠nica": {
      "main": [[{"node": "Mesclar Contexto Completo"}]]
    },
    "Mesclar Contexto Completo": {
      "main": [[{"node": "GPT: Classificar Inten√ß√£o"}]]
    },
    "GPT: Classificar Inten√ß√£o": {
      "main": [[{"node": "Inten√ß√£o: INFORMA√á√ÉO?"}, {"node": "Inten√ß√£o: AGENDAR?"}]]
    },
    "Inten√ß√£o: INFORMA√á√ÉO?": {
      "main": [[{"node": "GPT: Responder Informa√ß√£o"}]]
    },
    "Inten√ß√£o: AGENDAR?": {
      "main": [[{"node": "Verificar Paciente Existe"}]]
    },
    "Verificar Paciente Existe": {
      "main": [[{"node": "Paciente Cadastrado?"}]]
    },
    "Paciente Cadastrado?": {
      "main": [
        [{"node": "GPT: Selecionar Procedimento"}],
        [{"node": "GPT: Coletar Dados do Paciente"}]
      ]
    },
    "GPT: Coletar Dados do Paciente": {
      "main": [[{"node": "API: Criar Paciente"}]]
    },
    "API: Criar Paciente": {
      "main": [[{"node": "GPT: Selecionar Procedimento"}]]
    },
    "GPT: Selecionar Procedimento": {
      "main": [[{"node": "API: Verificar Disponibilidade"}]]
    },
    "API: Verificar Disponibilidade": {
      "main": [[{"node": "Hor√°rio Dispon√≠vel?"}]]
    },
    "Hor√°rio Dispon√≠vel?": {
      "main": [
        [{"node": "API: Criar Agendamento"}],
        [{"node": "GPT: Oferecer Alternativas"}]
      ]
    },
    "API: Criar Agendamento": {
      "main": [[{"node": "Preparar Notifica√ß√µes"}]]
    },
    "GPT: Oferecer Alternativas": {
      "main": [[{"node": "Formatar Resposta Final"}]]
    },
    "Preparar Notifica√ß√µes": {
      "main": [[{"node": "API: Enviar Notifica√ß√µes"}]]
    },
    "API: Enviar Notifica√ß√µes": {
      "main": [[{"node": "Formatar Resposta Final"}]]
    },
    "GPT: Responder Informa√ß√£o": {
      "main": [[{"node": "Formatar Resposta Final"}]]
    },
    "Formatar Resposta Final": {
      "main": [[{"node": "Enviar Resposta ao Sistema"}]]
    },
    "Enviar Resposta ao Sistema": {
      "main": [[{"node": "Webhook Response"}]]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "1",
  "id": "zorahbot-intelligence-main",
  "meta": {
    "instanceId": "zorahapp-n8n"
  },
  "tags": []
}
