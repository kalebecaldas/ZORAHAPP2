// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String
  password  String
  role      String    @default("ATENDENTE")
  isMasterFrozen Boolean @default(false)
  lastLoginAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  conversations Conversation[]
  auditLogs    AuditLog[]
  quickReplies QuickReply[]
}

// ‚úÖ NOVO: Sistema de Atalhos (Respostas R√°pidas)
model QuickReply {
  id        String   @id @default(cuid())
  userId    String
  shortcut  String   // Ex: "saudacao", "horario", "preco"
  text      String   // Ex: "Ol√°! Meu nome √©..."
  isGlobal  Boolean  @default(false) // Se true, dispon√≠vel para todos os usu√°rios
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, shortcut])
  @@index([userId])
}

model Patient {
  id               String    @id @default(cuid())
  phone            String    @unique
  name             String
  cpf              String?   @unique
  email            String?
  birthDate        DateTime?
  address          String?
  emergencyContact String?
  insuranceCompany String?
  insuranceNumber  String?
  preferences      Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  conversations Conversation[]
  appointments  Appointment[]
  interactions  PatientInteraction[]
}

model Conversation {
  id             String    @id @default(cuid())
  phone          String
  status         String    @default("BOT_QUEUE")
  assignedToId   String?
  patientId      String?
  lastMessage    String
  lastTimestamp  DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  workflowId     String?
  currentWorkflowNode String?
  workflowContext Json?
  awaitingInput  Boolean   @default(false)
  
  // Session management fields
  sessionStartTime  DateTime? 
  sessionExpiryTime DateTime?
  sessionStatus     String    @default("active")  // 'active', 'warning', 'expired', 'closed'
  lastUserActivity  DateTime?
  
  // Multi-channel support
  channel           String    @default("whatsapp")  // 'whatsapp', 'instagram', 'messenger'
  channelMetadata   Json?
  
  // ‚úÖ NOVO: Contador de mensagens n√£o lidas
  unreadCount       Int       @default(0)
  
  assignedTo User?    @relation(fields: [assignedToId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  patient    Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  messages   Message[]
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  phoneNumber    String
  messageText    String
  messageType    String    @default("TEXT") // TEXT, IMAGE, DOCUMENT, AUDIO, VIDEO, SYSTEM
  mediaUrl       String?   // URL da m√≠dia (para imagens, documentos, √°udio, v√≠deo)
  metadata       Json?     // Metadados adicionais (filename, mimetype, caption, etc)
  direction      String
  from           String
  timestamp      DateTime  @default(now())
  createdAt      DateTime  @default(now())
  
  // ‚úÖ NOVO: Mensagens do sistema
  systemMessageType String?  // AGENT_ASSIGNED, TRANSFERRED_TO_QUEUE, TRANSFERRED_TO_AGENT, TIMEOUT_INACTIVITY, etc
  systemMetadata    Json?    // { agentName, queueName, targetAgentName, reason }
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model PatientInteraction {
  id          String   @id @default(cuid())
  patientId   String
  type        String
  description String?
  data        Json?
  createdAt   DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("CONVERSATION")
  config      Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Appointment {
  id             String    @id @default(cuid())
  patientId      String
  patientName    String
  patientPhone   String
  procedure      String
  date           DateTime
  time           String
  notes          String?
  status         String    @default("SCHEDULED")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model InsuranceCompany {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  displayName String
  discount  Boolean  @default(false)
  discountPercentage Float? @default(0)
  isParticular Boolean @default(false)
  isActive  Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicInsurances ClinicInsurance[]
  clinicProcedures ClinicInsuranceProcedure[]
}

model Procedure {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  importantInfo String?
  basePrice   Float
  requiresEvaluation Boolean @default(false)
  duration    Int
  categories  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinicProcedures ClinicInsuranceProcedure[]
  offeredBy        ClinicProcedure[]         @relation("offeredBy")
}

model Clinic {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  displayName String
  address   String
  neighborhood String
  city      String
  state     String
  zipCode   String
  phone     String
  email     String?
  openingHours Json
  coordinates Json?
  specialties Json
  parkingAvailable Boolean @default(false)
  accessibility Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicInsurances  ClinicInsurance[]
  clinicProcedures  ClinicInsuranceProcedure[]
  offeredProcedures ClinicProcedure[]          @relation("offeredProcedures")
}

model ClinicInsurance {
  id            String   @id @default(cuid())
  clinicId      String
  insuranceCode String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  insurance InsuranceCompany @relation(fields: [insuranceCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, insuranceCode])
}

model ClinicProcedure {
  id            String   @id @default(cuid())
  clinicId      String
  procedureCode String
  isActive      Boolean  @default(true)
  notes         String?
  defaultPrice  Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic    @relation(name: "offeredProcedures", fields: [clinicId], references: [id], onDelete: Cascade)
  procedure Procedure @relation(name: "offeredBy", fields: [procedureCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, procedureCode])
  @@index([clinicId])
  @@index([procedureCode])
}

model ClinicInsuranceProcedure {
  id            String   @id @default(cuid())
  clinicId      String
  insuranceCode String
  procedureCode String
  price         Float
  hasPackage    Boolean  @default(false)
  packageInfo   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  insurance InsuranceCompany @relation(fields: [insuranceCode], references: [code], onDelete: Cascade)
  procedure Procedure        @relation(fields: [procedureCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, insuranceCode, procedureCode])
}

model AILearningData {
  id        String   @id @default(cuid())
  phone     String
  intent    String?
  sentiment String?
  style     String?
  context   Json?
  createdAt DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String
  targetUserId String?
  action      String
  details     Json?
  createdAt   DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)
}

model Template {
  id          String   @id @default(cuid())
  key         String   @unique
  category    String
  title       String
  description String?
  content     String
  variables   Json
  example     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// CONFIGURA√á√ÉO DA IA CONVERSACIONAL
// ============================================

model AIConfiguration {
  id                String   @id @default(cuid())
  
  // Identifica√ß√£o
  name              String   @default("Configura√ß√£o Principal")
  description       String?
  
  // Prompt Base
  systemPrompt      String   @db.Text
  personality       String   @default("Emp√°tica e profissional")
  tone              String   @default("Conversacional e amig√°vel")
  
  // Comportamento
  useEmojis         Boolean  @default(true)
  offerPackages     Boolean  @default(true)
  askInsurance      Boolean  @default(true)
  maxResponseLength Int      @default(500)
  
  // Regras de Neg√≥cio (JSON configur√°vel)
  businessRules     Json?
  
  // Configura√ß√µes Avan√ßadas
  temperature       Float    @default(0.7)
  maxTokens         Int      @default(1000)
  
  // Controle
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Rela√ß√µes
  examples          AIExample[]
  transferRules     TransferRule[]
}

// Exemplos de conversas para treinar a IA (Few-Shot Learning)
model AIExample {
  id              String   @id @default(cuid())
  configId        String
  config          AIConfiguration @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  // Identifica√ß√£o
  name            String
  description     String?
  category        String   @default("GERAL") // AGENDAMENTO, INFORMACAO, ATRASO, etc
  
  // Exemplo de Conversa
  userMessage     String   @db.Text
  expectedIntent  String   // INFORMACAO, AGENDAR, CANCELAR, etc
  expectedAction  String   // continue, transfer_human, start_workflow, collect_data
  botResponse     String   @db.Text
  
  // Entidades Esperadas
  entities        Json     // { procedimento, convenio, clinica, data, horario }
  
  // Metadados
  confidence      Float    @default(0.95)
  priority        Int      @default(0) // Ordem de import√¢ncia
  
  // Controle
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([configId, isActive])
  @@index([category])
}

// Regras de Transfer√™ncia para Humano
model TransferRule {
  id              String   @id @default(cuid())
  configId        String
  config          AIConfiguration @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  // Identifica√ß√£o
  name            String
  description     String?
  
  // Condi√ß√µes de Ativa√ß√£o
  keywords        String[] // Palavras-chave que ativam a regra
  intents         String[] // Inten√ß√µes que ativam a regra
  minConfidence   Float    @default(0.6)
  
  // A√ß√£o
  targetQueue     String   // AGUARDANDO, PRIORITY_QUEUE, HUMAN_QUEUE
  priority        Int      @default(0) // Prioridade da regra (maior = mais importante)
  
  // Mensagem de Transfer√™ncia
  transferMessage String?  @db.Text
  
  // Controle
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([configId, isActive])
  @@index([priority])
}

// ‚úÖ NOVO: Configura√ß√µes do Sistema
model SystemSettings {
  id                        String   @id @default(cuid())
  
  // Timeout de inatividade
  inactivityTimeoutMinutes  Int      @default(10)
  
  // Mensagem de encerramento
  closingMessage            String   @default("Obrigado pelo contato! Estamos √† disposi√ß√£o. üòä") @db.Text
  
  // Outras configura√ß√µes
  autoAssignEnabled         Boolean  @default(true)
  maxConversationsPerAgent  Int      @default(5)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@map("system_settings")
}

