// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String
  password  String
  role      String    @default("ATENDENTE")
  isMasterFrozen Boolean @default(false)
  lastLoginAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  conversations Conversation[]
  auditLogs    AuditLog[]
}

model Patient {
  id               String    @id @default(cuid())
  phone            String    @unique
  name             String
  cpf              String?   @unique
  email            String?
  birthDate        DateTime?
  address          String?
  emergencyContact String?
  insuranceCompany String?
  insuranceNumber  String?
  preferences      Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  conversations Conversation[]
  appointments  Appointment[]
  interactions  PatientInteraction[]
}

model Conversation {
  id             String    @id @default(cuid())
  phone          String
  status         String    @default("BOT_QUEUE")
  assignedToId   String?
  patientId      String?
  lastMessage    String
  lastTimestamp  DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  workflowId     String?
  currentWorkflowNode String?
  workflowContext Json?
  awaitingInput  Boolean   @default(false)
  
  assignedTo User?    @relation(fields: [assignedToId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  patient    Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  messages   Message[]
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  phoneNumber    String
  messageText    String
  direction      String
  from           String
  timestamp      DateTime  @default(now())
  createdAt      DateTime  @default(now())
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model PatientInteraction {
  id          String   @id @default(cuid())
  patientId   String
  type        String
  description String?
  data        Json?
  createdAt   DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("CONVERSATION")
  config      Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Appointment {
  id             String    @id @default(cuid())
  patientId      String
  patientName    String
  patientPhone   String
  procedure      String
  date           DateTime
  time           String
  notes          String?
  status         String    @default("SCHEDULED")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model InsuranceCompany {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  displayName String
  discount  Boolean  @default(false)
  discountPercentage Float? @default(0)
  isParticular Boolean @default(false)
  isActive  Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicInsurances ClinicInsurance[]
  clinicProcedures ClinicInsuranceProcedure[]
}

model Procedure {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String
  importantInfo String?
  basePrice   Float
  requiresEvaluation Boolean @default(false)
  duration    Int
  categories  Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinicProcedures ClinicInsuranceProcedure[]
  offeredBy        ClinicProcedure[]         @relation("offeredBy")
}

model Clinic {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  displayName String
  address   String
  neighborhood String
  city      String
  state     String
  zipCode   String
  phone     String
  email     String?
  openingHours Json
  coordinates Json?
  specialties Json
  parkingAvailable Boolean @default(false)
  accessibility Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicInsurances  ClinicInsurance[]
  clinicProcedures  ClinicInsuranceProcedure[]
  offeredProcedures ClinicProcedure[]          @relation("offeredProcedures")
}

model ClinicInsurance {
  id            String   @id @default(cuid())
  clinicId      String
  insuranceCode String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  insurance InsuranceCompany @relation(fields: [insuranceCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, insuranceCode])
}

model ClinicProcedure {
  id            String   @id @default(cuid())
  clinicId      String
  procedureCode String
  isActive      Boolean  @default(true)
  notes         String?
  defaultPrice  Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic    @relation(name: "offeredProcedures", fields: [clinicId], references: [id], onDelete: Cascade)
  procedure Procedure @relation(name: "offeredBy", fields: [procedureCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, procedureCode])
  @@index([clinicId])
  @@index([procedureCode])
}

model ClinicInsuranceProcedure {
  id            String   @id @default(cuid())
  clinicId      String
  insuranceCode String
  procedureCode String
  price         Float
  hasPackage    Boolean  @default(false)
  packageInfo   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic    Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  insurance InsuranceCompany @relation(fields: [insuranceCode], references: [code], onDelete: Cascade)
  procedure Procedure        @relation(fields: [procedureCode], references: [code], onDelete: Cascade)

  @@unique([clinicId, insuranceCode, procedureCode])
}

model AILearningData {
  id        String   @id @default(cuid())
  phone     String
  intent    String?
  sentiment String?
  style     String?
  context   Json?
  createdAt DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  actorId     String
  targetUserId String?
  action      String
  details     Json?
  createdAt   DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)
}
